# AI Function Execution Flow Diagrams

## 1. Production Bot Action Flow (Actual Code)

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   User Input    │───▶│  Agent Chat UI   │───▶│  OpenAI API     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  AI Response    │◀───│  executeToolCall │◀───│ AI Function Call│
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │ fetchAgentTools  │
                       │   (Database)     │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │applyParamMapping │
                       │  (AI → Tool)     │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │  execSkillById   │
                       │   (Switch)       │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │ Dynamic Import   │
                       │ Skill Handler    │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │  API Call        │
                       │  /api/rag/place  │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │ Response Process │
                       └──────────────────┘
```

## 2. Test Tool Flow (Actual Code)

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Test Form      │───▶│ Test Parameters  │───▶│ POST Request    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│ Test Results    │◀───│ Tool Test Router │◀───│ /tool-test/     │
│   Display       │    │                  │    │ execute         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │ getToolConfig    │
                       │ (DB or Temp)     │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │applyParameterMap │
                       │  (AI → Tool)     │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │ Execute Handler  │
                       │   (Switch)       │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │ executeRagPlace  │
                       │    Handler       │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │  API Call        │
                       │  /api/rag/place  │
                       └──────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │ Response Process │
                       └──────────────────┘
```

## 3. Shared Skill Handler Functions

```
┌─────────────────────────────────────────────────────────────────┐
│                    SHARED SKILL HANDLERS                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Production Flow:          Test Flow:                           │
│  ┌─────────────────┐      ┌─────────────────┐                  │
│  │ragPlaceSearch   │      │executeRagPlace  │                  │
│  │Handler()        │      │Handler()        │                  │
│  └─────────────────┘      └─────────────────┘                  │
│           │                        │                           │
│           └────────┬─────────────────┘                           │
│                    ▼                                             │
│         ┌─────────────────────┐                                 │
│         │   SAME LOGIC        │                                 │
│         │                     │                                 │
│         │ • Parameter Mapping │                                 │
│         │ • API Call          │                                 │
│         │ • Response Process  │                                 │
│         │ • Error Handling    │                                 │
│         └─────────────────────┘                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 4. Parameter Mapping Flow

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│ AI Parameters   │───▶│ Parameter Mapping│───▶│ Tool Parameters │
│                 │    │   (Database)     │    │                 │
│ searchQuery     │    │                  │    │ text_query      │
│ lat             │    │ {"searchQuery":  │    │ lat             │
│ long            │    │  "text_query"}   │    │ long            │
│ category        │    │                  │    │ category        │
│ maxResults      │    │                  │    │ top_k           │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 5. Complete System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    RAG BACKEND SYSTEM                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                    ┌─────────────────┐    │
│  │   PRODUCTION    │                    │   TEST TOOLS    │    │
│  │                 │                    │                 │    │
│  │ User → Chat →   │                    │ Form → Test →   │    │
│  │ OpenAI → AI     │                    │ Handler → API   │    │
│  │ Function Call   │                    │ Call → Results  │    │
│  └─────────────────┘                    └─────────────────┘    │
│           │                                    │               │
│           └────────────┬───────────────────────┘               │
│                        ▼                                       │
│         ┌─────────────────────────────────────┐                │
│         │        SHARED HANDLERS              │                │
│         │                                     │                │
│         │  • ragPlaceSearchHandler            │                │
│         │  • webSearchHandler                 │                │
│         │  • httpRequestHandler               │                │
│         │  • ragSearchHandler                 │                │
│         │  • textSummarizeHandler             │                │
│         │  • timeNowHandler                   │                │
│         │  • ragContextsHandler               │                │
│         │  • dataParseCSVHandler              │                │
│         │  • dataParseJSONHandler             │                │
│         │  • webBrowseHandler                 │                │
│         │  • webCrawlHandler                  │                │
│         └─────────────────────────────────────┘                │
│                        │                                       │
│                        ▼                                       │
│         ┌─────────────────────────────────────┐                │
│         │         API ENDPOINTS               │                │
│         │                                     │                │
│         │  • /api/rag/place                   │                │
│         │  • /api/rag/summary                 │                │
│         │  • /api/rag/contexts                │                │
│         │  • External APIs                    │                │
│         └─────────────────────────────────────┘                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 6. File Structure

```
apps/
├── travel-ai-bot/
│   └── src/app/
│       ├── api/chat/agent-completions/
│       │   └── route.ts                    # Production flow
│       └── agents/core/functions/handlers/skill/
│           ├── rag-place.ts                # Shared handler
│           ├── web-search.ts               # Shared handler
│           ├── http-request.ts             # Shared handler
│           ├── rag-search.ts               # Shared handler
│           ├── text-summarize.ts           # Shared handler
│           ├── time-now.ts                 # Shared handler
│           ├── rag-contexts.ts             # Shared handler
│           ├── data-parse-csv.ts           # Shared handler
│           ├── data-parse-json.ts          # Shared handler
│           ├── web-browse.ts               # Shared handler
│           ├── web-crawl.ts                # Shared handler
│           └── index.ts                    # Handler exports
└── backend/
    └── src/routes/admin/
        └── toolTest.ts                     # Test flow
```

## 7. Key Code Locations

### Production Flow:
- **Entry Point**: `apps/travel-ai-bot/src/app/api/chat/agent-completions/route.ts`
- **Function**: `executeToolCall()` (Line 323)
- **Handler**: `execSkillById()` (Line 219)
- **Mapping**: `applyParamMapping()` (Line 206)

### Test Flow:
- **Entry Point**: `apps/backend/src/routes/admin/toolTest.ts`
- **Function**: `POST /tool-test/execute` (Line 10)
- **Handler**: `executeRagPlaceHandler()` (Line 172)
- **Mapping**: Parameter mapping logic (Line 51)

### Shared Handlers:
- **Location**: `apps/travel-ai-bot/src/app/agents/core/functions/handlers/skill/`
- **Files**: All `*.ts` files in the skill directory
- **Exports**: `index.ts` exports all handlers

## 8. Verification Results

```
✅ ALL 11 SKILL HANDLERS VERIFIED:
   • skill.web.search - WebSearchHandler
   • skill.http.request - HttpRequestHandler
   • skill.rag.search - RagSearchHandler
   • skill.text.summarize - TextSummarizeHandler
   • skill.time.now - TimeNowHandler
   • skill.rag.place - RagPlaceSearchHandler
   • skill.rag.contexts - RagContextsHandler
   • skill.data.parse.csv - DataParseCSVHandler
   • skill.data.parse.json - DataParseJSONHandler
   • skill.web.browse - WebBrowseHandler
   • skill.web.crawl - WebCrawlHandler

🎯 SUCCESS RATE: 11/11 (100%)
🚀 ALL TEST TOOL FLOWS ARE NOW CORRECT!
```
